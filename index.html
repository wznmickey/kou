<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>扣</title>
</head>

<body>
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.9.0/dist/av-min.js"></script>
    <div style="text-align: center;">
        <progress id="file" style="height: 2vh;width: 50vw;">
        </progress>
        <p id="money" style="font-size:3em;margin:0px;">正在加载</p>
        <p><img src="img/logo.png"></p>

        <div style="display: flex;justify-content: center;align-items: center; ">
            <div id="wechatpay">
                <img src="img/wx.jpg" style="max-height: 70vw;height:30vh">
                <p style="font-size: 4em;margin:0px;">微信</p>
            </div>
            <div id="alipay">
                <img src="img/zfb.jpg" style="max-height: 70vw;height:30vh">
                <p style="font-size: 4em;margin:0px;">支付宝</p>
            </div>
        </div>
        <p>
            <button id="switchpay" value="微信" onclick="switchpay()" style="font-size: xx-large;">微信二维码</button>
        </p>
        <button id="collect" onclick="collect()" style="font-size: xx-large;margin:0px;">填写信息</button>
        <table id="donator" style="text-align:center;margin:auto;font-size: xx-large;">
            <tr>
                <th>&emsp;&emsp;捐助者&emsp;&emsp;</th>
                <th>&emsp;&emsp;捐助金额&emsp;&emsp;</th>
                <th>&emsp;&emsp;捐助时间&emsp;&emsp;</th>
            </tr>
        </table>
    </div>
    <script>
        var pay_way = 0;
        /*
            0-wechatpay;
            1-alipay;
        */
        if (pay_way == 0) { document.getElementById("wechatpay").hidden = false; document.getElementById("alipay").hidden = true; document.getElementById("switchpay").innerHTML = "切换至支付宝二维码"; }
        if (pay_way == 1) { document.getElementById("alipay").hidden = false; document.getElementById("wechatpay").hidden = true; document.getElementById("switchpay").innerHTML = "切换至微信二维码"; }
        function switchpay() {
            pay_way = (pay_way + 1) % 2;
            if (pay_way == 0) { document.getElementById("wechatpay").hidden = false; document.getElementById("alipay").hidden = true; document.getElementById("switchpay").innerHTML = "切换至支付宝二维码"; }
            if (pay_way == 1) { document.getElementById("alipay").hidden = false; document.getElementById("wechatpay").hidden = true; document.getElementById("switchpay").innerHTML = "切换至微信二维码"; }
        }
        function alipay() {
            window.location.href = "./img/zfb.jpg";
        }
        function wechatpay() {
            window.location.href = "./img/wx.jpg";
        }

        function collect() {
            window.location.href = "./collect.html";
        }
        AV.init({
            appId: "OwNd3b8n9D9DYb3ApIeQk5FD-9Nh9j0Va",
            appKey: "3djw6bxOwueACjIh6COzUz80",
            serverURL: "https://kouapi.wznmickey.com"
        });
        tableNode = document.getElementById("donator");
        var donator_num = 0;
        var donatedmoney = 0;
        var aimmoney = 0;
        const Qmoney = new AV.Query('Money');
        Qmoney.find().then((money) => {
            aimmoney = money[0].get('money');
        });
        const Qdonator = new AV.Query('donator');
        Qdonator.count().then((count) => {
            donator_num = count;
            Qdonator.ascending('time');
            Qdonator.find().then((money) => {
                for (var i = 0; i < donator_num; i++) {
                    donatedmoney = donatedmoney + money[i].get('money');
                    var trNode = tableNode.insertRow();
                    var tdNode = trNode.insertCell();
                    tdNode.innerHTML = money[i].get('Name');
                    var tdNode = trNode.insertCell();
                    tdNode.innerHTML = money[i].get('money') + "元";
                    var tdNode = trNode.insertCell();
                    tdNode.innerHTML = money[i].get('time').getFullYear() + "年" + (money[i].get('time').getMonth() + 1) + "月" + money[i].get('time').getDate() + "日";
                }
                document.getElementById("money").innerHTML = "当前金额：" + donatedmoney.toFixed(2) + "/" + aimmoney;
                document.getElementById("file").max = aimmoney;
                document.getElementById("file").value = donatedmoney;
            });
        });
    </script>
</body>

</html>